{% extends "layouts/base.html" %}

{% block title %} New Task {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
{% load crispy_forms_tags %}
{% endblock stylesheets %}

{% block content %}
<div class="container-fluid">
    <div class="mb-3 mb-lg-0">
        <h1 class="h4">Create Task</h1>
    </div>
</div>
<div class="container-fluid">
    <div class="card border-0 shadow components-section">
        <div class="card-body">
            <form method="post" action="{% url 'task:create' %}">
            {% csrf_token %}

    <div class="row mb-5">
        <div class="col-sm-4">
            <label for="title">Task Title:</label>
            <input type="text" class="form-control" name="title" required>
        </div>
    </div>
    <div class="row mb-5">
        <div class="col-sm-3">
            <label for="department">Select Department:</label>
            <select name="department" class="form-select" id="departmentSelect">
                <option value="">-- Select Department --</option>
                {% for department in departments %}
                    <option value="{{ department.id }}">{{ department.department }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-sm-3">
            <label for="role">Select Role:</label>
            <select name="role" class="form-select" id="roleSelect">
                <option value="">-- Select Role --</option>
                {% for role in roles %}
                    <option value="{{ role.id }}">{{ role.title }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-sm-3" id="assignedToSection" style="display: none;">

                <p>Assign To:</p>
                <div id="assignedToCheckbox">
                    <!-- Assigned to checkboxes will be added here -->
                </div>
        </div>
    </div>
    <div class="row mb-10" >
        <div class="col-md-12 text-center">
            <a href="{% if 'task' in request.path %} {% url 'task:list' %} {% else %} {% url 'task:main' %} {% endif %} " class="btn btn-gray-300">Cancel</a>
            <input type="submit" class="btn btn-success"  >
        </div>
    </div>
    </form>
    </div>
    </div> 
</div>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

<script>
    document.getElementById('departmentSelect').addEventListener('change', updateAssignedTo);
    document.getElementById('roleSelect').addEventListener('change', updateAssignedTo);

    function updateAssignedTo() {
        const department = document.getElementById('departmentSelect').value;
        const role = document.getElementById('roleSelect').value;

        if (department && role) {
            fetch(`task/create/get_employees/?department=${department}&role=${role}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received data:', data); // Log the received data

                    const assignedToCheckbox = document.getElementById('assignedToCheckbox');
                    assignedToCheckbox.innerHTML = ''; // Clear existing checkboxes

                    if (data && data.length > 0) {
                        data.forEach(employee => {
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.name = 'assigned_to';
                            checkbox.value = employee.id;
                            checkbox.classList.add('form-check-input');
                            const label = document.createElement('label');
                            label.appendChild(checkbox);
                            label.appendChild(document.createTextNode(' '+ employee.user__first_name + ' ' + employee.user__last_name));
                            assignedToCheckbox.appendChild(label);
                        });
                        document.getElementById('assignedToSection').style.display = 'block';
                    } else {
                        console.log('No data received or empty data.'); // Log if no or empty data received
                        document.getElementById('assignedToSection').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
        } else {
            document.getElementById('assignedToSection').style.display = 'none';
        }
    }
</script>

{% endblock javascripts %}