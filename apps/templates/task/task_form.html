{% extends "layouts/base.html" %}

{% block title %} New Task {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
{% load crispy_forms_tags %}
{% endblock stylesheets %}

{% block content %}
<!DOCTYPE html>
<html>
<head>
    <title>Create Task</title>
</head>
<body>
    <h1>Create Task</h1>

    <form method="post" action="{% url 'task:create' %}">
        {% csrf_token %}

        <label for="title">Task Title:</label>
        <input type="text" name="title" required>

        <label for="department">Select Department:</label>
        <select name="department" id="departmentSelect">
            <option value="">-- Select Department --</option>
            {% for department in departments %}
                <option value="{{ department.id }}">{{ department.department }}</option>
            {% endfor %}
        </select>

        <label for="role">Select Role:</label>
        <select name="role" id="roleSelect">
            <option value="">-- Select Role --</option>
            {% for role in roles %}
                <option value="{{ role.id }}">{{ role.title }}</option>
            {% endfor %}
        </select>

        <div id="assignedToSection" style="display: none;">
            <p>Assign To:</p>
            <div id="assignedToCheckbox">
                <!-- Assigned to checkboxes will be added here -->
            </div>
        </div>

        <button type="submit">Create Task</button>
    </form>

    
</body>
</html>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

<script>
    document.getElementById('departmentSelect').addEventListener('change', updateAssignedTo);
    document.getElementById('roleSelect').addEventListener('change', updateAssignedTo);

    function updateAssignedTo() {
        const department = document.getElementById('departmentSelect').value;
        const role = document.getElementById('roleSelect').value;

        if (department && role) {
            fetch(`task/create/get_employees/?department=${department}&role=${role}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received data:', data); // Log the received data

                    const assignedToCheckbox = document.getElementById('assignedToCheckbox');
                    assignedToCheckbox.innerHTML = ''; // Clear existing checkboxes

                    if (data && data.length > 0) {
                        data.forEach(employee => {
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.name = 'assigned_to';
                            checkbox.value = employee.id;
                            const label = document.createElement('label');
                            label.appendChild(checkbox);
                            label.appendChild(document.createTextNode(employee.user__first_name + ' ' + employee.user__last_name));
                            assignedToCheckbox.appendChild(label);
                        });
                        document.getElementById('assignedToSection').style.display = 'block';
                    } else {
                        console.log('No data received or empty data.'); // Log if no or empty data received
                        document.getElementById('assignedToSection').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
        } else {
            document.getElementById('assignedToSection').style.display = 'none';
        }
    }
</script>

{% endblock javascripts %}